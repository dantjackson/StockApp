package com.get;

// https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(%22YHOO%22)&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=
	
// https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(%22YHOO%22)&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys


import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Reader;
import java.net.URL;
import java.nio.charset.Charset;
import java.sql.Connection;
import java.sql.SQLException;
import java.sql.Statement;

import org.json.JSONException;
import org.json.JSONObject;

public class StockReadYahooJSON {

  private static String readAll(Reader rd) throws IOException {
    StringBuilder sb = new StringBuilder();
    int cp;
    while ((cp = rd.read()) != -1) {
      sb.append((char) cp);
    }
    return sb.toString();
  }

  public static JSONObject readJsonFromUrl(String url) throws IOException, JSONException {
    InputStream is = new URL(url).openStream();
    try {
      BufferedReader rd = new BufferedReader(new InputStreamReader(is, Charset.forName("UTF-8")));
      String jsonText = readAll(rd);
      JSONObject json = new JSONObject(jsonText);
      return json;
    } finally {
      is.close();
    }
  }

  public static void main(String[] args) throws IOException, JSONException {
    //JSONObject json = readJsonFromUrl("https://graph.facebook.com/19292868552");
    
	 Connection con = null;  
	
	// To Test The Query https://developer.yahoo.com/yql/console/?debug=true#h=select+*+from+yahoo.finance.quotes
    JSONObject json = readJsonFromUrl("https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(%22YHOO%22)&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys");
    
    //System.out.println(json.toString());

    // Recurse the JSON object to the results JSON object
    JSONObject query = json.getJSONObject("query");
    JSONObject results = query.getJSONObject("results");
    JSONObject quote = results.getJSONObject("quote");
    
    for(int i = 0; i<quote.names().length(); i++){
   
	    // Create new StockDetail Class
	    StockDetail stockDetail = new StockDetail();
	    
	    // Set The Stock Class Values To ArrayList
	    String symbol = quote.getString("symbol");
	    
	    System.out.println(symbol);
	    
	    // Write the stock data to the StockDetailClass.
	    stockDetail.setStockID(symbol);
	    stockDetail.setName(quote.getString("Name"));
	    stockDetail.setBid(Double.parseDouble(quote.getString("Bid")));
	    stockDetail.setLastTradeDate(quote.getString("LastTradeDate"));
	    
	    // Create Arraylist of Class
	    
	    // Write Class Data To The DB
		try {
			con = SqlMySQLConn.getConnection();
			WritetoDB(stockDetail.getStockID(), con);
		} catch (SQLException e) {
			e.printStackTrace();
			throw new RuntimeException(e);
		} finally {
			SqlMySQLConn.close(con);
		}    

    } // For
  } // Sub JSON Read
  
  public static void WritetoDB(String StockId, Connection wrtCon)
  {
	  
      String InsrtSql = "INSERT INTO hokus.stock_detail " +
              " ( stock_id) " +
              " VALUES ( ?)";
      java.sql.PreparedStatement pstmt;
      
      System.out.println(InsrtSql);
	  
      try
      {  
          pstmt = wrtCon.prepareStatement(InsrtSql);
          wrtCon.setAutoCommit(true);    
    	  pstmt.setString (1, StockId);                  
              
           pstmt.addBatch();
           pstmt.executeBatch();
           System.out.println ("Committed.");
      }
      catch(Exception sqle)
      {
              System.out.println ("Exception in writing to the database "+ sqle.getMessage());
      }
  }
} // class

